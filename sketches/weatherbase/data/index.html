<html>
	<head>
		<meta charset="utf-8" />
		<title>Bolbro Wetter</title>
		<style>
			body { background-color: #ffffff; font-family: Arial, Helvetica, Sans-Serif; font-size: 27pt; color: #000000; }
			button { border: none; color: white; padding: 10px 16px; text-align: center; text-decoration: none; display: inline-block; font-size: 36pt; }
			ol { margin-left: 20pt; }
			.h3-style { font-size: 36pt; font-weight: bold;}
			.layout {
				display: grid;
				grid-template-rows: auto;
				grid-template-columns: 100%;
				grid-template-areas:
					"header"
					"current"
					"forecast"
					"station"
					"footer";
				grid-gap: 10px;
			}

			option { font-family: Arial, Helvetica, Sans-Serif; font-size: 27pt; }
			selection { font-family: Arial, Helvetica, Sans-Serif; font-size: 27pt; }

			.item-header { grid-area: header; padding-top: 1em; padding-left: 2em; padding-right: 2em; }
			.item-current { grid-area: current; padding-left: 2em; padding-right: 2em; }
			.item-forecast { grid-area: forecast; padding-left: 2em; padding-right: 2em; }
			.item-station { grid-area: station; padding-left: 2em; padding-right: 2em; }
			.item-footer { grid-area: footer; padding-left: 2em; padding-right: 2em; }

			table { margin-left:2em; }
			td { font-size: 27pt; padding-right: 20px; padding-bottom: 10px; }
			.forecast-table td { font-size: 27pt; padding: 10px; background-color:#F6F6F6; }
			.forecast-weekend-row td { font-size: 27pt; padding: 10px; background-color:#E6E6E6; }
		</style>
	</head>
	<body>
		<div class="layout">
			<div class="item-header">
				<center><img src="BolbroHaus.png"></img></center>
				<h2>Bolbro Wetter</h2>
				<p>Willkommen bei der <b>Bolbro Wetterstation</b>. Alle aktuellen Werte werden mit unserer Wetterstation
				gemessen und hier dargestellt. Die Station sieht klassisch aus, ist aber unheimlich <b>smart</b>. Mehr
				Informationen zur Station findest Du weiter unten.</p>
				<p id="message" hidden></p>
			</div>
			<div class="item-current">
				<h3>Aktuelle Werte</h3>
				<table id="weather-table">
 					<tr>
    					<td style="text-align:center"><img src="temperature.png" height="80"></td>
    					<td>Temperatur</td>
    					<td><span id="temperature">-</span></td>
  					</tr>
 					<tr>
    					<td style="text-align:center"><img src="humidity.png" height="80"></td>
    					<td>Luftfeuchtigkeit</td>
    					<td> <span id="humidity">-</span></td>
  					</tr>
 					<tr>
    					<td style="text-align:center"><img src="pressure.png" height="80"></td>
    					<td>Luftdruck</td>
    					<td> <span id="pressure">-</span></td>
  					</tr>
 					<tr>
    					<td style="text-align:center"><img src="rain.png" height="80"></td>
    					<td>Regen</td>
    					<td> <span id="rain">-</span></td>
  					</tr>
 					<tr>
    					<td style="text-align:center"><img src="wind.png" height="80"></td>
    					<td>Wind</td>
    					<td><span id="wind">-</span></td>
  					</tr>
 					<tr>
    					<td style="text-align:center"><img src="battery.png" height="80"></td>
    					<td>Batterie</td>
    					<td><span id="batterypercentage">-</span></td>
  					</tr>
 					<tr>
    					<td style="text-align:center"><img src="sun.png" height="80"></td>
    					<td>Sonne</td>
    					<td><span id="sun">-</span></td>
  					</tr>
 					<tr>
    					<td style="text-align:center"><img src="updated.png" height="80"></td>
    					<td>Meldung</td>
    					<td><span id="updated">-</span> <span id="offline"></span></td>
  					</tr>
				</table>
			</div>
			<div class="item-forecast" id="item_forecast" hidden>
				<h3>Vorhersage</h3>
				<table id="forecast-table" class="forecast-table">
				</table>
				<p><em>Daten <span id="station">-</span> (<a target="_blank" rel="noopener noreferrer" href="http://openweathermap.org">openweathermap.org</a>)</em></p>
			</div>
			<div class="item-station">
				<h3>&Uuml;ber die Station</h3>
				<p>Die Wetterstation ist ein <b>kompletter Eigenbau</b>. Die klassische Wetterh&uuml;tte wurde nach einem Bauplan
				des deutschen Wetterdiensts (DWD) gebaut. Nachdem Messinstrumente heute kleiner (und elektronisch) sind,
				ist eine solch grosse H&uuml;tte eigentlich nicht mehr n&ouml;tig. Sieht aber sch&ouml;n aus und stellt in jedem
				Fall sicher, dass die Temperatur-Werte nicht durch Sonneneinstrahlung und andere Witterungseinfl&uuml;sse
				verf&auml;lscht werden.</p>

				<p>Neben der Messung von <b>Temperatur</b>, <b>Luftfeuchtigkeit</b> und der <b>Barometer-Funktion</b>, misst die Wetterstation
				auch <b>Windrichtung</b> und <b>-Geschwindigkeit</b>. Weiterhin wird der <b>Niederschlag</b> gemessen. Wind und Niederschlag
				werden mechanisch gemessen. Die Mechanik wurde komplett neu konstruiert und kann mit einem 3D Drucker
				gedruckt werden. Die Modelle stellen wird im Netz zum Download zur Verf&uuml;gung.</p>

				<p>Zuletzt gibt es eine Menge Elektronik und Software. Auch die ist komplett selbst entworfen um unsere
				Anforderungen zu erf&uuml;llen. Wichtig war uns insbesondere, dass die Daten online ins Bolbro-Haus gemeldet
				und in die <b>Hausautomation</b> und <b>Energiemanagement</b> integriert werden. Dazu befindet sich in der Wetterh&uuml;tte ein Microcontroller,
				der regelm&auml;ssig alle Messungen durchf&uuml;hrt. Die Daten werden dann &uuml;ber eine "Long Range" Funktechnik
				ins Haus gemeldet. Hier befindet sich ein weiterer Microcontroller, der die Daten auf dieser Webseite
				aufbereitet und in die Heimautomatisierung speist. Schaltpl&auml;ne und Software haben wir ebenfalls
				ver&ouml;ffentlicht.</p>

				<p>Hier sind alle Links:
				<ul>
					<li><a target="_blank" rel="noopener noreferrer" href="http://www.met.fu-berlin.de/%7Estefan/huette.html">Bauanleitung Wetterh&uuml;tte</a></li>
					<li><a target="_blank" rel="noopener noreferrer" href="https://www.prusaprinters.org/social/92858-harry/prints">3D Modelle zum Drucken</a></li>
					<li><a target="_blank" rel="noopener noreferrer" href="https://github.com/HarrysLapTimer/WeatherStationOne">Schaltplan und Software</a></li>
				</ul></p>
			</div>
			<div class="item-footer">
				<p>Copyright &copy; 2022, Harald Schlangmann &ndash; <a href="administration.html">Administration</a></p>
			</div>
		</div>

		<script>

			//	TODO, multi-language-support: https://www.youtube.com/watch?v=PaJrDAmrOB4
			let windDirectionsArray = [ ['N', 'Nord'], ['NNE', 'Nordnordost'], ['NE', 'Nordost'], ['ENE', 'Ostnordost'],
					['E', 'Ost'], ['ESE', 'Osts&uuml;dost'], ['SE', 'S&uuml;dost'], ['SSE', 'S&uuml;ds&uuml;dost'],
					['S', 'S&uuml;d'], ['SSW', 'S&uuml;ds&uuml;dwest'], ['SW', 'S&uuml;dwest'], ['WSW', 'Wests&uuml;dwest'],
					['W', 'West'], ['WNW', 'Westnordwest'], ['NW', 'Nordwest'], ['NNW', 'Nordnordwest'] ];

			let windDirections = new Map(windDirectionsArray);

			let windSpeedUnit = "Bf";

			const coloredtemperatures = true;
			const forcasttabled = true;

			function getForecastDataWithConfiguration(latitude, longitude, numdays, apikey) {
				var xhttp = new XMLHttpRequest();
				xhttp.onreadystatechange = function() {
					if (this.readyState == 4 && this.status == 200) {

						var jsonObj = JSON.parse(this.responseText);

						var table = "";

						const dateoptions = { weekday: 'short', day: 'numeric' };
						const todaydate = new Date();
						const todaydatestr = todaydate.toLocaleDateString('de-DE', dateoptions);
						const tomorrowdate = new Date();
						tomorrowdate.setDate(tomorrowdate.getDate() + 1);
						const tomorrowdatestr = tomorrowdate.toLocaleDateString('de-DE', dateoptions);

						document.getElementById("station").innerHTML = jsonObj.city.name;

						jsonObj.list.forEach(function(obj) {

							/*
								{
									"dt":1639047600,
									"sunrise":1639035185,
									"sunset":1639061704,
									"temp":{
										"day":1.44,
										"min":0.38,
										"max":2.19,
										"night":2.19,
										"eve":0.65,
										"morn":1.23
									},
									"feels_like":{
										"day":-2.99,
										"night":-1.75,
										"eve":-3.19,
										"morn":-3.36
									},
									"pressure":1004,
									"humidity":93,
									"weather":[
										{
											"id":803,
											"main":"Clouds",
											"description":"broken clouds",
											"icon":"04d"
										}],
									"speed":5.32,
									"deg":136,
									"gust":8.79,
									"clouds":75,
									"pop":0
								}
							 */


							//	add date
							var date = new Date(0);
							date.setSeconds(obj.dt);

							datestr = date.toLocaleDateString('de-DE', dateoptions);

							if (datestr.startsWith("Sa")||datestr.startsWith("So"))
								table += "<tr class='forecast-weekend-row'>";
							else
								table += "<tr>";
							table += "<td>";

							if (datestr == tomorrowdatestr)
								datestr = "Morgen";
							if (datestr == todaydatestr)
								datestr = "Heute";

							table += datestr;
							table += "</td>";

							//	add icon
							table += "<td style=\"text-align:center\"><img src=\"WeatherIcon";
							table += obj.weather[0].icon;
							table += ".png\" height=\"80\"></td>";

							//	add temperature
							table += "<td style='text-align:right'>";
							if (coloredtemperatures) {
								table += "<span style=\"color:blue\">&mapstodown;";
								table += obj.temp.min.toFixed(0);
								table += "</span>";
								table += " <span style=\"color:red\">&mapstoup;";
								table += obj.temp.max.toFixed(0);
								table += "</span> &#8451;";
							} else {
								table += "&mapstodown;";
								table += obj.temp.min.toFixed(0);
								table += " ";
								table += "&mapstoup;";
								table += obj.temp.max.toFixed(0);
								table += " &#8451;";
							}

							//	add wind
							if (forcasttabled)
								table += "</td><td style='text-align:right'>";
							else
								table += "&#12539;";

							switch(windSpeedUnit) {
								case "m/s":
									table += obj.speed.toFixed(1); // 1
									table += " <sup>m</sup>&frasl;<sub>s</sub>";
									break;
								case "kn":
									table += (obj.speed * 1.94384).toFixed(1);
									table += " kn";
									break;
								case "Bf":
									table += Math.pow (obj.speed/0.836,2.0/3.0).toFixed(0);
									table += " Bf";
									break;
							}
							if (obj.deg) {
								//	add short form of wind direction
								var winddirectionindex = (Math.round(obj.deg/45)*2)%16;
								//	... and map East to Ost
								table += " <img src='wind" + windDirectionsArray[winddirectionindex][0] + ".png' height='32' style='vertical-align:middle'>";
							}

							//	add rain
							if (forcasttabled)
								table += "</td><td>";
							if ("rain" in obj) {
								if (!forcasttabled)
									table += "&#12539;";
								table += "<img src='raindrop.png' height='32' style='vertical-align:middle'> ";
								table += obj.rain.toFixed(1);
								table += " mm";
							} else if (forcasttabled)
								table += "trocken";

							table += "</td>";

							table += "</tr>";
						});

						document.getElementById("forecast-table").innerHTML = table;
						document.getElementById("item_forecast").hidden = false;
					}
				};

				xhttp.open("GET", "http://api.openweathermap.org/data/2.5/forecast/daily?lat=" +
							latitude + "&lon=" +longitude + "&cnt=" + numdays + "&units=metric&mode=json&APPID=" + apikey, true);
				xhttp.send();
			}

			function getForecastData() {

				document.getElementById("item_forecast").hidden = true;

				var xhttp = new XMLHttpRequest();
				xhttp.onreadystatechange = function() {
					if (this.readyState == 4 && this.status == 200) {
						var jsonObj = JSON.parse(this.responseText);

						getForecastDataWithConfiguration(jsonObj.latitude, jsonObj.longitude, jsonObj.numdays, jsonObj.apikey)
					}
				};

				xhttp.open("GET", "forecast-configuration.json", true);
				xhttp.send();
			}

			function getWeatherData() {
				var xhttp = new XMLHttpRequest();
				xhttp.onreadystatechange = function() {
					if (this.readyState == 4 && this.status == 200) {

						var jsonObj = JSON.parse(this.responseText);

						if ("message" in jsonObj) {
							document.getElementById("message").innerHTML = "<span style='color:red'>" + jsonObj.message + "</span>";
							document.getElementById("message").hidden = false;
						} else
							document.getElementById("message").hidden = true;

						var temperature = "-";

						if (jsonObj.weather.temperature!="-") {
							temperature = jsonObj.weather.temperature + " &#8451;";

							if (jsonObj.aggregated.mintemperature!="-"&&jsonObj.aggregated.maxtemperature!="-") {
								if (coloredtemperatures) {
									temperature = temperature + " (<span style='color:blue'>&mapstodown;" + jsonObj.aggregated.mintemperature + "</span> <span style='color:red'>&mapstoup;" + jsonObj.aggregated.maxtemperature + "</span>)"
								} else {
									temperature = temperature + " (&mapstodown;" + jsonObj.aggregated.mintemperature + " &mapstoup;"  + jsonObj.aggregated.maxtemperature + ")"
								}
							}
						}
						document.getElementById("temperature").innerHTML = temperature;

						document.getElementById("humidity").innerHTML = jsonObj.weather.humidity=="-"?"-":jsonObj.weather.humidity + " %rH";

						var pressure = "-";

						if (jsonObj.weather.pressure!="-") {
							pressure = jsonObj.weather.pressure + " hPa"
							if (jsonObj.aggregated.barotrend!="-") {
								if (jsonObj.aggregated.barotrend>1)
									pressure = pressure + " steigend";
								else if (jsonObj.aggregated.barotrend<-1)
									pressure = pressure + " fallend";
							}
						}
						document.getElementById("pressure").innerHTML = pressure;

						var rain = "-";

						if (jsonObj.aggregated.rainhour=="-")
							rain = "-";
						else {
							rain = jsonObj.aggregated.rainhour + " <sup>mm</sup>&frasl;<sub>h</sub>";

							if (jsonObj.aggregated.rainday!="-")
								rain = rain + ", " + jsonObj.aggregated.rainday + " <sup>mm</sup>&frasl;<sub>Tag</sub>";
						}
						document.getElementById("rain").innerHTML = rain;

						var wind = "-";

						if (jsonObj.aggregated.windmps=="-")
							if (jsonObj.weather.winddirection=="-")
								wind = "-";
							else
								wind = jsonObj.weather.winddirection;
						else {
							switch(windSpeedUnit) {
								case "m/s":
									wind = jsonObj.aggregated.windmps;
									break;
								case "kn":
									wind = jsonObj.aggregated.windknots;
									break;
								case "Bf":
									wind = jsonObj.aggregated.windbeaufort;
									break;
							}

							var htmlWindSpeedUnit = windSpeedUnit

							if (htmlWindSpeedUnit=="m/s")
								htmlWindSpeedUnit = "<sup>m</sup>&frasl;<sub>s</sub>"
							wind = wind + " <button style='background-color: #60c9f8; font-size: 27pt; padding: 0px;' type='button' onclick='changeWindSpeedUnit()'>" + htmlWindSpeedUnit + "</button>";

							switch(windSpeedUnit) {
								case "m/s":
									if (jsonObj.aggregated.gustsmps!="-"&&jsonObj.aggregated.gustsmps!=jsonObj.aggregated.windmps)
										wind = wind + " (B&ouml;en " + jsonObj.aggregated.gustsmps + ")";
									break;
								case "kn":
									if (jsonObj.aggregated.gustsknots!="-"&&jsonObj.aggregated.gustsknots!=jsonObj.aggregated.windknots)
										wind = wind + " (B&ouml;en " + jsonObj.aggregated.gustsknots + ")";
									break;
								case "Bf":
									if (jsonObj.aggregated.gustsbeaufort!="-"&&jsonObj.aggregated.gustsbeaufort!=jsonObj.aggregated.windbeaufort)
										wind = wind + " (B&ouml;en " + jsonObj.aggregated.gustsbeaufort + ")";
									break;
							}

							if (jsonObj.weather.winddirection!="-") {
								// wind = wind + " " + windDirections.get(jsonObj.weather.winddirection);
								wind += " <img src='wind" + jsonObj.weather.winddirection + ".png' height='32' style='vertical-align:middle'>&nbsp;";
								wind += jsonObj.weather.winddirection.replace(/E/g,"O");
							}
						}
						document.getElementById("wind").innerHTML = wind;

						var sun = "-";

						if (jsonObj.sun.azimuth=="-"||jsonObj.sun.inclination=="-")
							sun = "-";
						else
							sun = "<img src='inclination.png' height='32' style='vertical-align:middle'> " + jsonObj.sun.inclination + "&deg; <img src='azimuth.png' height='40' style='vertical-align:middle'> " + jsonObj.sun.azimuth + "&deg;";
						document.getElementById("sun").innerHTML = sun;

						document.getElementById("batterypercentage").innerHTML = jsonObj.weather.batterypercentage=="-"?"-":jsonObj.weather.batterypercentage + " %";
						document.getElementById("updated").innerHTML = jsonObj["updated-de"];

						if (jsonObj["updated-de"]!="-")
							if (jsonObj["offline"])
								document.getElementById("offline").innerHTML = "<img src='RedDot12.png' height='12' style='vertical-align:middle'>";
							else
								document.getElementById("offline").innerHTML = "<img src='GreenDot12.png' height='12' style='vertical-align:middle'>";
						else
							document.getElementById("offline").innerHTML = "";
					}
				};
				xhttp.open("GET", "weatherdata.json", true);
				xhttp.send();
			}

			function administration() {
				window.location.href = "administration.html";
			}

			function changeWindSpeedUnit()  {
				switch(windSpeedUnit) {
					case "m/s":
						windSpeedUnit = "kn";
						break;
					case "kn":
						windSpeedUnit = "Bf";
						break;
					case "Bf":
						windSpeedUnit = "m/s";
						break;
				}
				getWeatherData();
				getForecastData();
			}

			//	one time calls
			setInterval(function() {getWeatherData();}, 5*1000);
			getWeatherData();

			setInterval(function() {getForecastData();}, 15*60*1000 );
			getForecastData();

    	</script>
	</body>
</html>